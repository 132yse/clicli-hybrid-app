<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
        /*[v-cloak] {
            display: none;
        }*/

        html,
        body {
            background-color: #fff;
            padding: 0;
            margin: 0;
        }

        .content-container{
            margin-top: 56.25vw;
            /*padding: 10px 2vw;
            background-color: #FEFEFE;
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;*/
        }

        /*番剧简介*/
        .post-intro{
            padding: 20px 0;
            height: 120px;
            background-color: #FEFEFE;
            position: relative;
            box-shadow: 1px 1px 5px #ddd;
        }
        .post-intro .intro-img{
            height: 120px;
            width: 90px;
            float: left;
            margin: 0 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 5px;
            background-color: #009688;
            border: 1px solid #ddd;
        }
        .post-intro .intro-content{
            color: #515151;
            padding-right: 15px;
        }
        .intro-content .intro-title{
            color: #515151;
            font-size: 18px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .intro-content .statistic{
            padding: 10px 0;
            background-color: #FEFEFE;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .statistic .pv-icon{
            height: 20px;
            width: 20px;
            margin-right: 5px;
        }
        .statistic .pv{
            color: #999;
            font-size: 16px;
            margin-right: 10px;
        }
        .statistic .comments-icon{
            height: 18px;
            width: 18px;
            margin-right: 5px;
        }
        .statistic .comments-num{
            color: #999;
            font-size: 16px;
            margin-right: 10px;
        }
        .post-label span{
            padding: 5px 10px;
            background-color: #F2AA24;
            border-radius: 5px;
            color: #FFF;
            margin-right: 6px;
            font-size: 14px;
        }

        /*番剧集数列表*/
        .video-list{
            padding: 10px 2vw;
            background-color: #FEFEFE;
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;
            clear: both;
        }

        .video-item{
            width: 44vw;
            height: 60px;
            background-color: #FEFEFE;
            margin: 10px 2vw;
            border-radius: 5px;
            box-shadow: 3px 3px 8px #999;
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;
        }

        .video-item .avatar{
            height: 40px;
            width: 40px;
            margin: 10px;
            border-radius: 50%;
            background-image: url('../../image/avatar2.png');
            background-position: center;
            background-size: contain;
        }
        .video-item .intro{
            width: 70px;
        }
        .intro .oid{
            color: #515151;
            font-size: 16px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .intro .title{
            color: #515151;
            font-size: 14px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

    </style>
</head>

<body>

    <div id="app" v-cloak>

        <div class="content-container">

            <div class="post-intro">
                <div :style="getImgUrl(postIntro.content)" alt="" class="intro-img"></div>
                <div class="intro-content">
                    <div class="intro-title">关于我转生变成史莱姆这档事 [史傲天]</div>
                    <div class="statistic">
                        <img class="pv-icon" src="../../image/pv.png" alt=""><span class="pv">2000</span>
                        <img class="comments-icon" src="../../image/comments.png" alt=""><span class="comments-num">100</span>
                    </div>
                    <div class="post-label">
                        <span>新番</span>
                        <span>推荐</span>
                    </div>
                </div>
            </div>

            <div class="video-list">
                <div class="video-item" v-for="item in videosList" @click="playVideo(item.content,item.title,$event)">
                    <img :src="getUqq(item.uqq)" alt="" class="avatar">
                    <div class="intro">
                        <p class="oid">第{{item.oid}}话</p>
                        <p class="title">{{item.title}}</p>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script src="../../script/api.js"></script>
    <script src="../../script/vue.min.js"></script>
    <script src="../../script/axios.min.js"></script>
    <script src="../../script/hyperdown.js"></script>
    <script type="text/javascript">
        apiready = () => {

            let pid = api.pageParam.pid
            let title = api.pageParam.title

            let videoPlayer = api.require('videoPlayer')
            let _isFullScreen = false

            const app = new Vue({
                el: '#app',
                data: {
                    postIntro: [],
                    postContent: '',
                    videosList: [],
                    postCount: {},
                    commentsList: []
                },
                mounted() {
                    this.getPostIntro()
                    this.getVideosList()
                    this.getPostCount()
                    this.getCommentsList()
                },
                methods: {
                    getPostIntro(){
                        axios({
                            method: 'get',
                            url: 'https://api.clicli.top/post/' + pid
                        }).then(response => {
                            if(response.data.code === 201){
                                this.postIntro = response.data.result
                                let parser = new HyperDown
                                let html = parser.makeHtml(response.data.result.content)
                                this.postContent = html
                                console.log(html);
                            }
                        })
                    },
                    getVideosList(){
                        axios({
                            method: 'get',
                            url: 'https://api.clicli.top/videos?pid=' + pid + '&page=1&pageSize=100'
                        }).then(response => {
                            if(response.data.code === 201){
                                this.videosList = response.data.videos
                                this.loadVideoPlayer(response.data.videos[0].content,response.data.videos[0].title)
                                setTimeout(()=>{
                                    document.querySelectorAll('.video-item')[0].style.background = 'rgba(0,156,255,0.4)'
                                },100)
                            }
                        })
                    },
                    getPostCount(){
                        axios({
                            method: 'get',
                            url: 'https://api.clicli.top/count/' + pid
                        }).then(response => {
                            if(response.data.code === 201){
                                this.postCount = response.data.count
                            }
                        })
                    },
                    getCommentsList(){
                        axios({
                            method: 'get',
                            url: 'https://api.clicli.top/comments?pid=' + pid + '&page=1&pageSize=100'
                        }).then(response => {
                            if(response.data.code === 201){
                                this.commentsList = response.data.comments
                            }
                        })
                    },
                    getUqq(email){
                        return 'http://q1.qlogo.cn/g?b=qq&nk='+email.split('@qq')[0]+'&s=5'
                    },
                    getImgUrl(content){
                        return 'background-image:url('+ (content || "").split(')')[0].split('[suo](')[1] +')'
                    },
                    playVideo(url,title,e){
                        videoPlayer.close()
                        this.loadVideoPlayer(url,title)
                        e.currentTarget.style.background = 'rgba(0,156,255,0.4)'
                    },
                    loadVideoPlayer(url,title){

                        axios({
                            method: 'get',
                            url: 'https://www.clicli.top/jx?url=' + url
                        }).then(response => {
                            if(response.data.code === 0){
                                console.log(response.data.url)
                                // return response.data.url
                                _initVideoClient(response.data.url,title)
                            }
                        })
                    }
                }
            })


            //初始化播放器
            function _initVideoClient(url,title){
                videoPlayer.openPlay({
                    rect: {
                        x: 0,
                        y: 0,
                        w: api.winWidth,
                        h: 9 / 16 * api.winWidth
                    },
                    texts: {
                        head: {
                            title
                        }
                    },
                    styles: {
                        head: {
                            bg: 'rgba(0.5,0.5,0.5,0.7)',
                            height: 44,
                            y: 20,
                            titleSize: 20,
                            titleColor: '#fff',
                            backSize: 22,
                            backImg: 'fs://image/back.png',
                            customButtons: [],
                        },
                        foot: {
                            bg: 'rgba(0,0,0,0)',
                            height: 44,
                            playSize: 22,
                            playImg: 'fs://img/paly.png',
                            pauseImg: 'fs://img/pause.png',
                            timeSize: 14,
                            timeColor: '#fff',
                            sliderImg: 'fs://img/slder.png',
                            progressColor: '#BEBEBE',
                            progressSelected: '#1296db',
                            rotationSize: 22,
                            verticalImg: 'widget://image/fullscreen.png',
                            horizontalImg: 'widget://image/fullscreen.png',
                        }
                    },
                    path: url,
                    coverImg: 'widget://image/coverImg.png',
                    autoPlay: true,
                    fixed: true
                }, function(ret, err) {
                    if (ret.eventType === 'back') {
                        if (ret.value === false) {
                            api.closeWin();
                        }
                    }else if(ret.eventType === 'failed'){
                        api.toast({
                            msg: '播放失败',
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                });

                api.addEventListener({
                    name: 'keyback'
                }, function(ret, err) {
                    //判断当前是否处于全屏播放
                    videoPlayer.isFullscreen(function(ret) {
                        if (ret.isFullscreen === false) {
                            videoPlayer.close()
                            api.closeWin()
                        } else {
                            videoPlayer.onBack()
                        }
                    })
                });
            }

        }
    </script>
</body>

</html>
